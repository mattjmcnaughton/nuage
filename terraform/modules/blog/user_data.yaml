#cloud-config
system_info:
  default_user:
    name: mattjmcnaughton

write_files:
  - path: /root/ssl.sh
    # Runs as root.
    content: |
      #!/bin/bash
      set -ex

      # To be safe, stop nginx while we replace the certs. We don't want anyone
      # trying to access the site while its using the self-signed certs.
      systemctl stop nginx.service

      aws s3 cp s3://g-mattjmcnaughton/ssl/mattjmcnaughton.com/fullchain.pem /etc/ssl/certs/fullchain.pem
      aws s3 cp s3://g-mattjmcnaughton/ssl/mattjmcnaughton.com/privkey.pem /etc/ssl/private/privkey.pem

      chmod 0600 /etc/ssl/certs/fullchain.pem
      chmod 0600 /etc/ssl/private/privkey.pem

      rm /etc/ssl/certs/mattjmcnaughton.com.crt
      ln -s /etc/ssl/certs/fullchain.pem /etc/ssl/certs/mattjmcnaughton.com.crt

      rm /etc/ssl/private/mattjmcnaughton.com.key
      ln -s /etc/ssl/private/privkey.pem /etc/ssl/private/mattjmcnaughton.com.key

      systemctl start nginx.service

runcmd:
  - bash /root/ssl.sh
